<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Data Cloud Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        {% include 'sidebar.html' %}
        
        <div class="main-content">
            <header class="page-header">
                <h1>üìä Dashboard</h1>
                <div class="header-actions">
                    <button onclick="sendPersonalizedEmails()" class="btn btn-primary" id="sendEmailsBtn" style="margin-right: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üìß Deliver Personalised Content
                    </button>
                    <button onclick="refreshDashboard()" class="btn btn-primary" id="refreshBtn" style="margin-right: 10px;">
                        üîÑ Refresh Stats
                    </button>
                    <span class="user-info">üë§ {{ username }}</span>
                    <a href="/logout" class="btn btn-secondary">Logout</a>
                </div>
            </header>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon">üè¢</div>
                    <div class="stat-content">
                        <h3>Accounts</h3>
                        <div class="stat-number">{{ stats.accounts|default(0) }}</div>
                        <a href="/data?object=Account" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <h3>Cases</h3>
                        <div class="stat-number">{{ stats.cases|default(0) }}</div>
                        <a href="/data?object=Case" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üîó</div>
                    <div class="stat-content">
                        <h3>Account Contacts</h3>
                        <div class="stat-number">{{ stats.account_contacts|default(0) }}</div>
                        <a href="/data?object=AccountContactRelation" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <h3>Opportunities</h3>
                        <div class="stat-number">{{ stats.opportunities|default(0) }}</div>
                        <a href="/data?object=Opportunity" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
            </div>
            
            <!-- Second Row: Data Cloud Profiles -->
            <div class="dashboard-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-icon">üë§</div>
                    <div class="stat-content">
                        <h3>Individuals</h3>
                        <div class="stat-number">{{ stats.individuals|default(0) }}</div>
                        <a href="/data?object=Individual" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-content">
                        <h3>Unified Individuals</h3>
                        <div class="stat-number">{{ stats.unified_individuals|default(0) }}</div>
                        <a href="/data?object=UnifiedIndividual__dlm" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üß™</div>
                    <div class="stat-content">
                        <h3>Synthetic Profiles</h3>
                        <div class="stat-number">{{ stats.synthetic_profiles|default(0) }}</div>
                        <a href="/individual_engagement" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-content">
                        <h3>Leads</h3>
                        <div class="stat-number">{{ stats.leads|default(0) }}</div>
                        <a href="/data?object=ssot__Lead__dlm" class="stat-link">View all ‚Üí</a>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <h2>üöÄ Quick Actions</h2>
                <div class="action-grid">
                    <a href="/data" class="action-card">
                        <div class="action-icon">üìä</div>
                        <h3>Manage Data</h3>
                        <p>Create, update, and delete records</p>
                    </a>
                    
                    <a href="/relationships" class="action-card">
                        <div class="action-icon">üîó</div>
                        <h3>Build Relationships</h3>
                        <p>Connect records across objects</p>
                    </a>
                    
                    <a href="/segments" class="action-card">
                        <div class="action-icon">üéØ</div>
                        <h3>Create Segments</h3>
                        <p>Filter and group your audience</p>
                    </a>
                    
                    <a href="/emails" class="action-card">
                        <div class="action-icon">üìß</div>
                        <h3>Send Emails</h3>
                        <p>Generate personalized campaigns</p>
                    </a>
                </div>
            </div>
            
            <div class="datacloud-stats" style="margin-top: 30px;">
                <h2>‚òÅÔ∏è Real Data Cloud Analytics</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Live statistics from your Data Cloud engagement objects</p>
                <div id="datacloudStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card clickable-card" onclick="showDataCloudRecords('BU2_EmailEngagement__dlm', 'üìß Email Engagements')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; transition: transform 0.2s;">
                        <div class="stat-content">
                            <h3 style="color: white;">üìß Email Engagements</h3>
                            <div class="stat-number" id="dcEmailTotal">Loading...</div>
                            <small style="opacity: 0.9;">From BU2_EmailEngagement__dlm</small>
                            <small style="opacity: 0.7; display: block; margin-top: 5px;">üëâ Click to view records</small>
                        </div>
                    </div>
                    <div class="stat-card clickable-card" onclick="showDataCloudRecords('E_Commerce_App_Behavioral_Event_E4C9EA42__dlm', 'üåê Website Events')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; cursor: pointer; transition: transform 0.2s;">
                        <div class="stat-content">
                            <h3 style="color: white;">üåê Website Events</h3>
                            <div class="stat-number" id="dcWebTotal">Loading...</div>
                            <small style="opacity: 0.9;">From E-Commerce Behavioral Events</small>
                            <small style="opacity: 0.7; display: block; margin-top: 5px;">üëâ Click to view records</small>
                        </div>
                    </div>
            <div class="stat-card clickable-card" onclick="showDataCloudRecords('ExternalOrders__dlm', 'üõí Total Orders')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; cursor: pointer; transition: transform 0.2s;">
                <div class="stat-content">
                    <h3 style="color: white;">üõí Total Orders</h3>
                    <div class="stat-number" id="dcOrderTotal">Loading...</div>
                    <small style="opacity: 0.9;">From ExternalOrders__dlm</small>
                    <small style="opacity: 0.7; display: block; margin-top: 5px;">üëâ Click to view records</small>
                </div>
            </div>
            <div class="stat-card clickable-card" onclick="showDataCloudRecords('BU2_MessageEngagement__dlm', 'üì± Message Engagements')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; cursor: pointer; transition: transform 0.2s;">
                <div class="stat-content">
                    <h3 style="color: white;">üì± Message Engagements</h3>
                    <div class="stat-number" id="dcMessageTotal">Loading...</div>
                    <small style="opacity: 0.9;">SMS, WhatsApp, Push</small>
                    <small style="opacity: 0.7; display: block; margin-top: 5px;">üëâ Click to view records</small>
                </div>
            </div>
        </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h3 style="margin-top: 0;">üí° Omnichannel Data Approach</h3>
                    <p style="margin-bottom: 10px;">This application combines:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>Test Individuals (100):</strong> With synthetic omnichannel engagement (Email, SMS, WhatsApp, Push, Website)</li>
                        <li><strong>Real Data Cloud:</strong> 12.7M+ email engagements, 19.8K+ message engagements, 339K+ website events, 312K+ orders</li>
                        <li><strong>Live Analytics:</strong> Real-time statistics from your actual Data Cloud objects</li>
                        <li><strong>Omnichannel Segmentation:</strong> Create segments based on any channel or combination of channels</li>
                    </ul>
                </div>
            </div>
            
            <div class="getting-started">
                <h2>üëã Getting Started</h2>
                <div class="steps">
                    <div class="step">
                        <span class="step-number">1</span>
                        <div class="step-content">
                            <h3>Create Data</h3>
                            <p>Start by creating Individual and Contact records</p>
                            <a href="/data" class="btn btn-sm">Go to Data Management</a>
                        </div>
                    </div>
                    
                    <div class="step">
                        <span class="step-number">2</span>
                        <div class="step-content">
                            <h3>Build Relationships</h3>
                            <p>Link Individuals to Contacts and Campaigns</p>
                            <a href="/relationships" class="btn btn-sm">Open Relationship Builder</a>
                        </div>
                    </div>
                    
                    <div class="step">
                        <span class="step-number">3</span>
                        <div class="step-content">
                            <h3>Create Segments</h3>
                            <p>Filter records based on criteria (engagement, demographics)</p>
                            <a href="/segments" class="btn btn-sm">Create Segment</a>
                        </div>
                    </div>
                    
                    <div class="step">
                        <span class="step-number">4</span>
                        <div class="step-content">
                            <h3>Send Personalized Emails</h3>
                            <p>Generate and send VIP welcome emails to your segment</p>
                            <a href="/emails" class="btn btn-sm">Create Campaign</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Refresh entire dashboard
        async function sendPersonalizedEmails() {
            const btn = document.getElementById('sendEmailsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Sending...';
            btn.disabled = true;
            
            // Show status message
            const statusDiv = document.createElement('div');
            statusDiv.id = 'emailStatus';
            statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; max-width: 400px;';
            statusDiv.innerHTML = '<h3>üìß Sending Personalized Emails</h3><p>Generating content for 5 segment members...</p><div style="margin-top: 10px;"><div style="background: #f0f0f0; border-radius: 5px; overflow: hidden;"><div id="progressBar" style="background: #667eea; height: 4px; width: 0%; transition: width 0.3s;"></div></div></div>';
            document.body.appendChild(statusDiv);
            
            try {
                const response = await fetch('/api/personalized-content/send-test-emails', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                // Check if response is actually JSON before parsing
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 200)}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <h3 style="color: #4caf50;">‚úÖ Emails Sent!</h3>
                        <p><strong>Sent:</strong> ${result.total_sent}</p>
                        <p><strong>Pending:</strong> ${result.total_pending}</p>
                        <p><strong>Failed:</strong> ${result.total_failed}</p>
                        <p style="margin-top: 15px; font-size: 12px; color: #666;">
                            üìß Check your inbox at:<br>
                            ‚Ä¢ bbanerjee@salesforce.com<br>
                            ‚Ä¢ ursonly_rup@yahoo.co.uk
                        </p>
                        <button onclick="document.getElementById('emailStatus').remove()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <h3 style="color: #f44336;">‚ùå Error</h3>
                        <p>${result.error || 'Unknown error'}</p>
                        <button onclick="document.getElementById('emailStatus').remove()" style="margin-top: 10px; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <h3 style="color: #f44336;">‚ùå Network Error</h3>
                    <p>${error.message}</p>
                    <button onclick="document.getElementById('emailStatus').remove()" style="margin-top: 10px; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                `;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function refreshDashboard() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Refreshing...';
            
            try {
                // Reload the entire page to get fresh stats from Salesforce
                window.location.reload();
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Refresh Stats';
                alert('Error refreshing dashboard. Please try again.');
            }
        }
        
        // Load Real Data Cloud Analytics
        async function loadDataCloudStats() {
            try {
                console.log('Loading Data Cloud stats...');
                const response = await fetch('/api/analytics/datacloud');
                const data = await response.json();
                console.log('Data Cloud stats response:', data);
                
            if (data.error) {
                console.error('Data Cloud API error:', data.error);
                document.getElementById('dcEmailTotal').textContent = 'Login Required';
                document.getElementById('dcMessageTotal').textContent = 'Login Required';
                document.getElementById('dcWebTotal').textContent = 'Login Required';
                document.getElementById('dcOrderTotal').textContent = 'Login Required';
                return;
            }
                
            // Update totals
            const emailCount = data.total_records?.email_engagements || 0;
            const messageCount = data.total_records?.message_engagements || 0;
            const webCount = data.total_records?.website_events || 0;
            const orderCount = data.total_records?.orders || 0;
            
            console.log('Updating UI with counts:', {emailCount, messageCount, webCount, orderCount});
            
            document.getElementById('dcEmailTotal').textContent = emailCount.toLocaleString();
            document.getElementById('dcMessageTotal').textContent = messageCount.toLocaleString();
            document.getElementById('dcWebTotal').textContent = webCount.toLocaleString();
            document.getElementById('dcOrderTotal').textContent = orderCount.toLocaleString();
                
            } catch (error) {
                console.error('Failed to load Data Cloud stats:', error);
                document.getElementById('dcEmailTotal').textContent = 'Error';
                document.getElementById('dcMessageTotal').textContent = 'Error';
                document.getElementById('dcWebTotal').textContent = 'Error';
                document.getElementById('dcOrderTotal').textContent = 'Error';
            }
        }
        
        // Load on page load
        document.addEventListener('DOMContentLoaded', loadDataCloudStats);
        
        // Show Data Cloud Records
        async function showDataCloudRecords(objectName, title) {
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">${title}</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">‚úï Close</button>
                </div>
                <p style="color: #666; margin-bottom: 15px;">Object: <code>${objectName}</code></p>
                <div id="recordsContent" style="min-height: 200px;">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <p>Loading records...</p>
                    </div>
                </div>
            `;
            
            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Fetch records
            try {
                const response = await fetch('/api/data/' + objectName + '/records?limit=20');
                const data = await response.json();
                
                const recordsDiv = document.getElementById('recordsContent');
                
                if (data.error) {
                    recordsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;"><div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div><h3>Error Loading Records</h3><p>' + data.error + '</p></div>';
                    return;
                }
                
                const records = data.records || [];
                const totalSize = data.totalSize || 0;
                
                if (records.length === 0) {
                    recordsDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">üì≠</div><h3>No Records Found</h3><p>This object doesn\'t contain any records yet.</p></div>';
                    return;
                }
                
                // Build table
                const fields = Object.keys(records[0]).filter(f => f !== 'attributes');
                const displayFields = fields.slice(0, 8);
                
                let tableHTML = '<div style="margin-bottom: 15px;"><strong>Total Records:</strong> ' + totalSize.toLocaleString() + ' | <strong>Showing:</strong> First ' + records.length + '</div>';
                tableHTML += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;"><thead><tr style="background: #667eea; color: white;">';
                
                displayFields.forEach(f => {
                    tableHTML += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">' + f + '</th>';
                });
                
                tableHTML += '</tr></thead><tbody>';
                
                records.forEach((record, idx) => {
                    const bgColor = idx % 2 === 0 ? '#f9f9f9' : 'white';
                    tableHTML += '<tr style="background: ' + bgColor + ';">';
                    displayFields.forEach(field => {
                        let value = record[field];
                        if (value === null || value === undefined) value = '-';
                        if (typeof value === 'string' && value.length > 50) value = value.substring(0, 50) + '...';
                        tableHTML += '<td style="padding: 8px; border: 1px solid #ddd;">' + value + '</td>';
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                
                if (fields.length > 8) {
                    tableHTML += '<p style="margin-top: 10px; color: #666; font-size: 12px;">... and ' + (fields.length - 8) + ' more fields</p>';
                }
                
                recordsDiv.innerHTML = tableHTML;
                
            } catch (error) {
                document.getElementById('recordsContent').innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;"><div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div><h3>Network Error</h3><p>' + error.message + '</p></div>';
            }
        }
        
        // Add hover effect for clickable cards
        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.clickable-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05) translateY(-5px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) translateY(0)';
                });
            });
        });
    </script>
</body>
</html>

