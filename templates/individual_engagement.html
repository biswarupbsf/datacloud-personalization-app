<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Engagement Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .engagement-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .engagement-table {
            width: 100%;
            min-width: 2400px;
            border-collapse: collapse;
        }
        
        .engagement-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .engagement-table th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
            color: white !important;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .engagement-table th.sortable:hover {
            background: rgba(0, 0, 0, 0.4) !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .sort-icon {
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
            opacity: 0.6;
        }
        
        .sort-icon.active {
            opacity: 1;
        }
        
        .engagement-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .engagement-table tbody tr:hover {
            background: #f8f9ff;
            cursor: pointer;
        }
        
        .score-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .score-high {
            background: #4caf50;
            color: white;
        }
        
        .score-medium {
            background: #ff9800;
            color: white;
        }
        
        .score-low {
            background: #f44336;
            color: white;
        }
        
        .channel-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .channel-email { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1565c0; border: 1px solid #90caf9; }
        .channel-sms { background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); color: #ad1457; border: 1px solid #f48fb1; }
        .channel-whatsapp { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #1b5e20; border: 1px solid #81c784; }
        .channel-push { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #6a1b9a; border: 1px solid #ba68c8; }
        .channel-website { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #e65100; border: 1px solid #ffb74d; }
        .channel-social { background: linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%); color: #c2185b; border: 1px solid #ec407a; }
        
        .metric-cell {
            text-align: center;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
        }
        
        @media (max-width: 1600px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-card-small {
            background: white;
            padding: 18px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-card-small h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card-small .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .export-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    
    <div class="main-content">
        <div class="header" style="margin-bottom: 15px;">
            <h1 style="margin-bottom: 5px; font-size: 28px;">ğŸ¯ Individual Engagement Dashboard</h1>
            <p style="margin: 0; color: #666; font-size: 14px;">Detailed omnichannel engagement metrics for all individuals</p>
        </div>
        
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div style="text-align: center;">
                <div class="spinner"></div>
                <p style="margin-top: 20px; font-weight: 600; color: #667eea; font-size: 18px;">Loading engagement data...</p>
                <p style="margin-top: 10px; color: #888; font-size: 14px;">Fetching channel metrics and individual insights</p>
            </div>
        </div>
        
        <!-- Summary Stats (Always Visible) -->
        <div class="stats-grid">
            <div class="stat-card-small">
                <h4>Total Individuals</h4>
                <div class="value" id="totalIndividuals">0</div>
            </div>
            <div class="stat-card-small">
                <h4>Avg Engagement Score</h4>
                <div class="value" id="avgEngagement">0</div>
            </div>
            <div class="stat-card-small">
                <h4>âœ‰ï¸ Total Email Opens</h4>
                <div class="value" id="totalEmailOpens">0</div>
            </div>
            <div class="stat-card-small">
                <h4>âœ‰ï¸ Total Email Clicks</h4>
                <div class="value" id="totalEmailClicks">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ’¬ Total SMS Opens</h4>
                <div class="value" id="totalSMSOpens">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ’¬ Total SMS Clicks</h4>
                <div class="value" id="totalSMSClicks">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ“ Total WhatsApp Opens</h4>
                <div class="value" id="totalWhatsAppOpens">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ“ Total WhatsApp Clicks</h4>
                <div class="value" id="totalWhatsAppClicks">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ”” Total Push Opens</h4>
                <div class="value" id="totalPushOpens">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ”” Total Push Clicks</h4>
                <div class="value" id="totalPushClicks">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ‘¥ Total Social Views</h4>
                <div class="value" id="totalSocialViews">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸ‘¥ Total Social Clicks</h4>
                <div class="value" id="totalSocialClicks">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸŒ Total Website Views</h4>
                <div class="value" id="totalWebsiteViews">0</div>
            </div>
            <div class="stat-card-small">
                <h4>ğŸŒ Total Website Clicks</h4>
                <div class="value" id="totalWebsiteClicks">0</div>
            </div>
        </div>
        
        <!-- Main Content (Filters & Table) -->
        <div id="mainContent" style="display: none;">
        <!-- Filters -->
        <div class="filters-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ” Filter & Search</h3>
                <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ Export to CSV</button>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search by Name</label>
                    <input type="text" id="searchName" placeholder="Type to search..." onkeyup="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Preferred Channel</label>
                    <select id="filterChannel" onchange="applyFilters()">
                        <option value="">All Channels</option>
                        <option value="Email">âœ‰ï¸ Email</option>
                        <option value="SMS">ğŸ’¬ SMS</option>
                        <option value="WhatsApp">ğŸ“ WhatsApp</option>
                        <option value="Push">ğŸ”” Push</option>
                        <option value="Website">ğŸŒ Website</option>
                        <option value="Social">ğŸ‘¥ Social</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Engagement Score</label>
                    <select id="filterScore" onchange="applyFilters()">
                        <option value="0">All Scores</option>
                        <option value="7">7+ (High)</option>
                        <option value="5">5+ (Medium)</option>
                        <option value="3">3+ (Low)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="omnichannel_score">Omnichannel Score</option>
                        <option value="engagement_score">Email Score</option>
                        <option value="email_opens">Email Opens</option>
                        <option value="sms_opens">SMS Opens</option>
                        <option value="whatsapp_reads">WhatsApp Reads</option>
                        <option value="website_product_views">Website Views</option>
                        <option value="total_order_value">Order Value</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Engagement Table -->
        <div class="engagement-table-container">
            <table class="engagement-table">
                <thead>
                    <tr>
                        <th style="min-width: 150px;" onclick="sortTable('Name')">Name <span class="sort-icon" id="sort-Name">â†•</span></th>
                        <th class="sortable" style="min-width: 100px; text-align: center;" onclick="sortTable('omnichannel_score')">Omni Score <span class="sort-icon" id="sort-omnichannel_score">â†•</span></th>
                        <th style="min-width: 120px; text-align: center;">Preferred Channel</th>
                        <th style="min-width: 150px; text-align: center;">ğŸ• Preferred Time</th>
                        <!-- Email Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #1976d2; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('email_opens')"><span style="font-size: 18px;">âœ‰ï¸</span> Opens</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #1976d2; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('email_clicks')"><span style="font-size: 18px;">âœ‰ï¸</span> Clicks</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #1976d2; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('email_deletes')"><span style="font-size: 18px;">âœ‰ï¸</span> Deletes</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #0d47a1; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('email_engagement_score')"><span style="font-size: 18px;">âœ‰ï¸</span> Score</th>
                        <!-- SMS Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #c2185b; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('sms_opens')"><span style="font-size: 18px;">ğŸ’¬</span> Opens</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #c2185b; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('sms_clicks')"><span style="font-size: 18px;">ğŸ’¬</span> Clicks</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #c2185b; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('sms_deletes')"><span style="font-size: 18px;">ğŸ’¬</span> Deletes</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #880e4f; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('sms_engagement_score')"><span style="font-size: 18px;">ğŸ’¬</span> Score</th>
                        <!-- WhatsApp Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #2e7d32; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('whatsapp_opens')"><span style="font-size: 18px;">ğŸ“</span> Opens</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #2e7d32; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('whatsapp_clicks')"><span style="font-size: 18px;">ğŸ“</span> Clicks</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #2e7d32; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('whatsapp_deletes')"><span style="font-size: 18px;">ğŸ“</span> Deletes</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #1b5e20; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('whatsapp_engagement_score')"><span style="font-size: 18px;">ğŸ“</span> Score</th>
                        <!-- Push Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #7b1fa2; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('push_opens')"><span style="font-size: 18px;">ğŸ””</span> Opens</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #7b1fa2; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('push_clicks')"><span style="font-size: 18px;">ğŸ””</span> Clicks</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #7b1fa2; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('push_deletes')"><span style="font-size: 18px;">ğŸ””</span> Deletes</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #4a148c; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('push_engagement_score')"><span style="font-size: 18px;">ğŸ””</span> Score</th>
                        <!-- Social Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #d81b60; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('social_views')"><span style="font-size: 18px;">ğŸ‘¥</span> Views</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #d81b60; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('social_clicks')"><span style="font-size: 18px;">ğŸ‘¥</span> Clicks</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #ad1457; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('social_engagement_score')"><span style="font-size: 18px;">ğŸ‘¥</span> Score</th>
                        <!-- Website Metrics -->
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #e65100; color: white; font-weight: 600; padding: 12px 8px; border-right: 2px solid white;" onclick="sortTable('website_product_views')"><span style="font-size: 18px;">ğŸŒ</span> Views</th>
                        <th class="sortable" style="min-width: 80px; text-align: center; background: #e65100; color: white; font-weight: 600; padding: 12px 8px; border-right: 3px solid #333;" onclick="sortTable('website_clicks')"><span style="font-size: 18px;">ğŸŒ</span> Clicks</th>
                        <th class="sortable" style="min-width: 90px; text-align: center; background: #bf360c; color: white; font-weight: 600; padding: 12px 8px;" onclick="sortTable('website_engagement_score')"><span style="font-size: 18px;">ğŸŒ</span> Score</th>
                    </tr>
                </thead>
                <tbody id="engagementTableBody">
                    <tr>
                        <td colspan="28" style="text-align: center; padding: 40px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
                            <p>Loading engagement data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #666;">
            Showing <strong id="displayCount">0</strong> of <strong id="totalCount">0</strong> individuals
        </div>
        </div> <!-- End mainContent -->
    </div>
    
    <script>
        let allIndividuals = [];
        let filteredIndividuals = [];
        let currentSortColumn = 'omnichannel_score';
        let currentSortDirection = 'desc';
        
        // Auto-load data on page load
        document.addEventListener('DOMContentLoaded', loadEngagementData);
        
        async function loadEngagementData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            try {
                const response = await fetch('/api/individuals/engagement');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load data');
                }
                
                allIndividuals = data.individuals;
                filteredIndividuals = [...allIndividuals];
                
                updateSummaryStats();
                
                // Set initial sort
                sortTable('omnichannel_score');
                
                // Show main content
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading engagement data:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('engagementTableBody').innerHTML = '<tr><td colspan="28" style="text-align: center; padding: 40px; color: #f44336;"><div style="font-size: 48px; margin-bottom: 15px;">âŒ</div><h3>Error Loading Data</h3><p>' + error.message + '</p><button onclick="loadEngagementData()" style="margin-top: 20px; background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">ğŸ”„ Try Again</button></td></tr>';
                document.getElementById('mainContent').style.display = 'block';
            }
        }
        
        function updateSummaryStats() {
            document.getElementById('totalIndividuals').textContent = allIndividuals.length;
            
            const avgEng = (allIndividuals.reduce((sum, ind) => sum + parseFloat(ind.engagement_score || 0), 0) / allIndividuals.length).toFixed(1);
            document.getElementById('avgEngagement').textContent = avgEng;
            
            // Email stats
            const totalEmailOpens = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.email_opens || 0), 0);
            document.getElementById('totalEmailOpens').textContent = totalEmailOpens.toLocaleString();
            const totalEmailClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.email_clicks || 0), 0);
            document.getElementById('totalEmailClicks').textContent = totalEmailClicks.toLocaleString();
            
            // SMS stats
            const totalSMSOpens = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.sms_opens || 0), 0);
            document.getElementById('totalSMSOpens').textContent = totalSMSOpens.toLocaleString();
            const totalSMSClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.sms_clicks || 0), 0);
            document.getElementById('totalSMSClicks').textContent = totalSMSClicks.toLocaleString();
            
            // WhatsApp stats
            const totalWhatsAppOpens = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.whatsapp_opens || 0), 0);
            document.getElementById('totalWhatsAppOpens').textContent = totalWhatsAppOpens.toLocaleString();
            const totalWhatsAppClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.whatsapp_clicks || 0), 0);
            document.getElementById('totalWhatsAppClicks').textContent = totalWhatsAppClicks.toLocaleString();
            
            // Push stats
            const totalPushOpens = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.push_opens || 0), 0);
            document.getElementById('totalPushOpens').textContent = totalPushOpens.toLocaleString();
            const totalPushClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.push_clicks || 0), 0);
            document.getElementById('totalPushClicks').textContent = totalPushClicks.toLocaleString();
            
            // Social stats
            const totalSocialViews = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.social_views || 0), 0);
            document.getElementById('totalSocialViews').textContent = totalSocialViews.toLocaleString();
            const totalSocialClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.social_clicks || 0), 0);
            document.getElementById('totalSocialClicks').textContent = totalSocialClicks.toLocaleString();
            
            // Website stats
            const totalWebsiteViews = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.website_product_views || 0), 0);
            document.getElementById('totalWebsiteViews').textContent = totalWebsiteViews.toLocaleString();
            const totalWebsiteClicks = allIndividuals.reduce((sum, ind) => sum + parseInt(ind.website_clicks || 0), 0);
            document.getElementById('totalWebsiteClicks').textContent = totalWebsiteClicks.toLocaleString();
        }
        
        function applyFilters() {
            const searchText = document.getElementById('searchName').value.toLowerCase();
            const channelFilter = document.getElementById('filterChannel').value;
            const scoreFilter = parseFloat(document.getElementById('filterScore').value);
            const sortBy = document.getElementById('sortBy').value;
            
            // Filter
            filteredIndividuals = allIndividuals.filter(ind => {
                const nameMatch = !searchText || ind.Name.toLowerCase().includes(searchText);
                const channelMatch = !channelFilter || ind.preferred_channel === channelFilter;
                const scoreMatch = parseFloat(ind.omnichannel_score || 0) >= scoreFilter;
                return nameMatch && channelMatch && scoreMatch;
            });
            
            // Sort
            filteredIndividuals.sort((a, b) => parseFloat(b[sortBy] || 0) - parseFloat(a[sortBy] || 0));
            
            renderTable();
        }
        
        function renderTable() {
            const tbody = document.getElementById('engagementTableBody');
            
            if (filteredIndividuals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="28" style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">ğŸ”</div><h3>No Results</h3><p>Try adjusting your filters</p></td></tr>';
                document.getElementById('displayCount').textContent = '0';
                document.getElementById('totalCount').textContent = allIndividuals.length;
                return;
            }
            
            let html = '';
            filteredIndividuals.forEach(ind => {
                const scoreValue = parseFloat(ind.omnichannel_score || 0);
                const scoreClass = scoreValue >= 7 ? 'score-high' : (scoreValue >= 5 ? 'score-medium' : 'score-low');
                const channelName = ind.preferred_channel || 'Email';
                const channelClass = 'channel-' + channelName.toLowerCase();
                
                // Get channel icon
                const channelIcons = {
                    'Email': 'âœ‰ï¸',
                    'SMS': 'ğŸ’¬',
                    'WhatsApp': 'ğŸ“',
                    'Push': 'ğŸ””',
                    'Website': 'ğŸŒ',
                    'Social': 'ğŸ‘¥'
                };
                const channelIcon = channelIcons[channelName] || 'ğŸ“§';
                
                html += '<tr onclick="showIndividualDetails(\'' + ind.Id + '\')">';
                html += '<td><strong>' + (ind.Name || '') + '</strong></td>';
                html += '<td class="metric-cell"><span class="score-badge ' + scoreClass + '">' + scoreValue.toFixed(1) + '</span></td>';
                html += '<td class="metric-cell"><span class="channel-badge ' + channelClass + '">' + channelIcon + ' ' + channelName + '</span></td>';
                html += '<td class="metric-cell"><span style="font-size: 11px; padding: 4px 8px; background: #f0f4ff; color: #4263eb; border-radius: 12px; display: inline-block;">' + (ind.preferred_contact_time || 'Not Set') + '</span></td>';
                // Email metrics
                html += '<td class="metric-cell" style="background: #e3f2fd; text-align: center;">' + parseInt(ind.email_opens || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #e3f2fd; text-align: center;">' + parseInt(ind.email_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #e3f2fd; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.email_deletes || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #bbdefb; text-align: center; font-weight: 600; border-right: 3px solid #333;"><span style="color: #0d47a1;">' + parseFloat(ind.email_engagement_score || 0).toFixed(1) + '</span></td>';
                // SMS metrics
                html += '<td class="metric-cell" style="background: #fce4ec; text-align: center;">' + parseInt(ind.sms_opens || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #fce4ec; text-align: center;">' + parseInt(ind.sms_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #fce4ec; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.sms_deletes || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #f8bbd0; text-align: center; font-weight: 600; border-right: 3px solid #333;"><span style="color: #880e4f;">' + parseFloat(ind.sms_engagement_score || 0).toFixed(1) + '</span></td>';
                // WhatsApp metrics
                html += '<td class="metric-cell" style="background: #e8f5e9; text-align: center;">' + parseInt(ind.whatsapp_opens || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #e8f5e9; text-align: center;">' + parseInt(ind.whatsapp_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #e8f5e9; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.whatsapp_deletes || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #c8e6c9; text-align: center; font-weight: 600; border-right: 3px solid #333;"><span style="color: #1b5e20;">' + parseFloat(ind.whatsapp_engagement_score || 0).toFixed(1) + '</span></td>';
                // Push metrics
                html += '<td class="metric-cell" style="background: #f3e5f5; text-align: center;">' + parseInt(ind.push_opens || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #f3e5f5; text-align: center;">' + parseInt(ind.push_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #f3e5f5; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.push_deletes || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #e1bee7; text-align: center; font-weight: 600; border-right: 3px solid #333;"><span style="color: #4a148c;">' + parseFloat(ind.push_engagement_score || 0).toFixed(1) + '</span></td>';
                // Social metrics
                html += '<td class="metric-cell" style="background: #fce4ec; text-align: center;">' + parseInt(ind.social_views || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #fce4ec; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.social_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #f8bbd0; text-align: center; font-weight: 600; border-right: 3px solid #333;"><span style="color: #ad1457;">' + parseFloat(ind.social_engagement_score || 0).toFixed(1) + '</span></td>';
                // Website metrics
                html += '<td class="metric-cell" style="background: #fff3e0; text-align: center;">' + parseInt(ind.website_product_views || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #fff3e0; text-align: center; border-right: 2px solid #666;">' + parseInt(ind.website_clicks || 0) + '</td>';
                html += '<td class="metric-cell" style="background: #ffe0b2; text-align: center; font-weight: 600;"><span style="color: #bf360c;">' + parseFloat(ind.website_engagement_score || 0).toFixed(1) + '</span></td>';
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
            document.getElementById('displayCount').textContent = filteredIndividuals.length;
            document.getElementById('totalCount').textContent = allIndividuals.length;
        }
        
        function showIndividualDetails(individualId) {
            const ind = allIndividuals.find(i => i.Id === individualId);
            if (!ind) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 800px; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            
            let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            html += '<h2 style="margin: 0;">ğŸ“Š ' + ind.Name + '</h2>';
            html += '<button onclick="this.closest(\'.modal-overlay\').remove()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">âœ• Close</button>';
            html += '</div>';
            
            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
            html += '<div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Omnichannel Score</div>';
            html += '<div style="font-size: 48px; font-weight: bold;">' + ind.omnichannel_score.toFixed(1) + '/10</div>';
            html += '<div style="opacity: 0.9;">ğŸ“± Preferred Channel: ' + ind.preferred_channel + '</div>';
            html += '<div style="opacity: 0.9;">ğŸ• Best Time to Contact: ' + (ind.preferred_contact_time || 'Not Set') + '</div>';
            html += '</div>';
            
            // Channel Engagement Scores
            html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
            html += '<h3 style="margin: 0 0 15px 0; color: #333;">ğŸ“Š Channel Engagement Scores</h3>';
            
            const channelScores = [
                { name: 'Email', icon: 'âœ‰ï¸', score: ind.email_engagement_score || 0, color: '#1565c0' },
                { name: 'SMS', icon: 'ğŸ’¬', score: ind.sms_engagement_score || 0, color: '#ad1457' },
                { name: 'WhatsApp', icon: 'ğŸ“', score: ind.whatsapp_engagement_score || 0, color: '#1b5e20' },
                { name: 'Push', icon: 'ğŸ””', score: ind.push_engagement_score || 0, color: '#6a1b9a' },
                { name: 'Website', icon: 'ğŸŒ', score: ind.website_engagement_score || 0, color: '#e65100' },
                { name: 'Social', icon: 'ğŸ‘¥', score: ind.social_engagement_score || 0, color: '#c2185b' }
            ];
            
            channelScores.forEach(channel => {
                const isPreferred = channel.name === ind.preferred_channel;
                html += '<div style="margin-bottom: 12px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">';
                html += '<span style="font-size: 13px; font-weight: ' + (isPreferred ? 'bold' : '500') + ';">' + channel.icon + ' ' + channel.name + (isPreferred ? ' â­' : '') + '</span>';
                html += '<span style="font-size: 13px; font-weight: 600; color: ' + channel.color + ';">' + channel.score.toFixed(1) + '/100</span>';
                html += '</div>';
                html += '<div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">';
                html += '<div style="background: ' + channel.color + '; height: 100%; width: ' + channel.score + '%; transition: width 0.3s;"></div>';
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">';
            
            // Email metrics
            html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“§ Email Engagement</h4>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Opens: <strong>' + ind.email_opens + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Clicks: <strong>' + ind.email_clicks + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Bounces: <strong>' + ind.email_bounces + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Unsubs: <strong>' + ind.email_unsubscribes + '</strong></div>';
            html += '</div>';
            
            // SMS metrics
            html += '<div style="background: #fce4ec; padding: 15px; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #c2185b;">ğŸ“± SMS Engagement</h4>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Sends: <strong>' + ind.sms_sends + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Opens: <strong>' + ind.sms_opens + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Clicks: <strong>' + ind.sms_clicks + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Open Rate: <strong>' + ind.sms_open_rate.toFixed(1) + '%</strong></div>';
            html += '</div>';
            
            // WhatsApp metrics
            html += '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ’¬ WhatsApp Engagement</h4>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Sends: <strong>' + ind.whatsapp_sends + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Reads: <strong>' + ind.whatsapp_reads + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Replies: <strong>' + ind.whatsapp_replies + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Read Rate: <strong>' + ind.whatsapp_read_rate.toFixed(1) + '%</strong></div>';
            html += '</div>';
            
            // Push metrics
            html += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">ğŸ”” Push Notifications</h4>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Sends: <strong>' + ind.push_sends + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Opens: <strong>' + ind.push_opens + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Clicks: <strong>' + ind.push_clicks + '</strong></div>';
            html += '<div style="font-size: 12px; margin: 5px 0;">Open Rate: <strong>' + ind.push_open_rate.toFixed(1) + '%</strong></div>';
            html += '</div>';
            
            html += '</div>';
            
            // Website behavior
            html += '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #e65100;">ğŸŒ Website Behavior</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">';
            html += '<div>Product Views: <strong>' + ind.website_product_views + '</strong></div>';
            html += '<div>Add to Cart: <strong>' + ind.website_add_to_cart + '</strong></div>';
            html += '<div>Cart Abandons: <strong>' + ind.website_cart_abandons + '</strong></div>';
            html += '<div>Purchases: <strong>' + ind.website_purchases + '</strong></div>';
            html += '<div>Order Value: <strong>$' + ind.total_order_value.toFixed(2) + '</strong></div>';
            html += '<div>Fav Category: <strong>' + (ind.favorite_category || 'N/A') + '</strong></div>';
            html += '</div>';
            html += '</div>';
            
            // Products
            if (ind.products_browsed && ind.products_browsed.length > 0) {
                html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">';
                html += '<h4 style="margin: 0 0 10px 0;">ğŸ›ï¸ Browsing History</h4>';
                html += '<div style="font-size: 12px;">' + ind.products_browsed.slice(0, 5).join(', ') + '</div>';
                html += '</div>';
            }
            
            modalContent.innerHTML = html;
            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        function sortTable(column) {
            // Toggle sort direction if clicking same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = column === 'Name' ? 'asc' : 'desc'; // Name defaults to asc, numbers to desc
            }
            
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = 'â†•';
                icon.classList.remove('active');
            });
            
            // Update active sort icon
            const activeIcon = document.getElementById('sort-' + column);
            if (activeIcon) {
                activeIcon.textContent = currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                activeIcon.classList.add('active');
            }
            
            // Sort the data
            filteredIndividuals.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle string comparison (for Name)
                if (column === 'Name') {
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                    if (currentSortDirection === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                }
                
                // Handle numeric comparison - parse strings to numbers
                aVal = parseFloat(aVal || 0);
                bVal = parseFloat(bVal || 0);
                if (currentSortDirection === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            renderTable();
        }
        
        function exportToCSV() {
            let csv = 'Name,Omnichannel Score,Preferred Channel,Preferred Time,';
            csv += 'Email Opens,Email Clicks,Email Deletes,Email Score,';
            csv += 'SMS Opens,SMS Clicks,SMS Deletes,SMS Score,';
            csv += 'WhatsApp Opens,WhatsApp Clicks,WhatsApp Deletes,WhatsApp Score,';
            csv += 'Push Opens,Push Clicks,Push Deletes,Push Score,';
            csv += 'Social Views,Social Clicks,Social Score,';
            csv += 'Website Views,Website Clicks,Website Score\n';
            
            filteredIndividuals.forEach(ind => {
                csv += '"' + ind.Name + '",';
                csv += ind.omnichannel_score + ',';
                csv += ind.preferred_channel + ',';
                csv += '"' + (ind.preferred_contact_time || 'Not Set') + '",';
                // Email
                csv += (ind.email_opens || 0) + ',';
                csv += (ind.email_clicks || 0) + ',';
                csv += (ind.email_deletes || 0) + ',';
                csv += (ind.email_engagement_score || 0) + ',';
                // SMS
                csv += (ind.sms_opens || 0) + ',';
                csv += (ind.sms_clicks || 0) + ',';
                csv += (ind.sms_deletes || 0) + ',';
                csv += (ind.sms_engagement_score || 0) + ',';
                // WhatsApp
                csv += (ind.whatsapp_opens || 0) + ',';
                csv += (ind.whatsapp_clicks || 0) + ',';
                csv += (ind.whatsapp_deletes || 0) + ',';
                csv += (ind.whatsapp_engagement_score || 0) + ',';
                // Push
                csv += (ind.push_opens || 0) + ',';
                csv += (ind.push_clicks || 0) + ',';
                csv += (ind.push_deletes || 0) + ',';
                csv += (ind.push_engagement_score || 0) + ',';
                // Social
                csv += (ind.social_views || 0) + ',';
                csv += (ind.social_clicks || 0) + ',';
                csv += (ind.social_engagement_score || 0) + ',';
                // Website
                csv += (ind.website_product_views || 0) + ',';
                csv += (ind.website_clicks || 0) + ',';
                csv += (ind.website_engagement_score || 0) + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'individual_engagement_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
        }
    </script>
</body>
</html>

